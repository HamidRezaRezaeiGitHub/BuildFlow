name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Detect changed files
      uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          frontend:
            - 'frontend/**'
          backend:
            - 'src/**'
            - 'pom.xml'
            - 'mvnw*'
            - '.mvn/**'

  frontend-test:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
      
    # Note: Skipping linting due to known ESLint configuration issues
    # - name: Lint frontend
    #   working-directory: ./frontend
    #   run: npm run lint
      
    - name: Upload frontend build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/
        retention-days: 1

  backend-test:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Make Maven wrapper executable
      run: chmod +x mvnw
      
    - name: Compile backend
      run: ./mvnw clean compile
      
    - name: Run backend tests
      run: ./mvnw test
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: target/surefire-reports/
        retention-days: 7

  integration-build:
    name: Full Integration Build
    runs-on: ubuntu-latest
    needs: [detect-changes, frontend-test, backend-test]
    if: always() && (needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch') && (needs.frontend-test.result == 'success' || needs.frontend-test.result == 'skipped') && (needs.backend-test.result == 'success' || needs.backend-test.result == 'skipped')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Make Maven wrapper executable
      run: chmod +x mvnw
      
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
      
    - name: Build complete application (with frontend integration)
      run: ./mvnw clean package -DskipTests
      
    - name: Verify JAR artifact
      run: |
        ls -la target/
        if [ ! -f target/BuildFlow-0.0.1-SNAPSHOT.jar ]; then
          echo "ERROR: Application JAR not found!"
          exit 1
        fi
        echo "SUCCESS: Application JAR created successfully"
        echo "JAR size: $(du -h target/BuildFlow-0.0.1-SNAPSHOT.jar | cut -f1)"
        
    - name: Upload application artifact
      uses: actions/upload-artifact@v4
      with:
        name: buildflow-application
        path: target/BuildFlow-0.0.1-SNAPSHOT.jar
        retention-days: 30
        
    - name: Test application startup (quick smoke test)
      run: |
        timeout 30s java -jar target/BuildFlow-0.0.1-SNAPSHOT.jar --server.port=0 --spring.profiles.active=test || true
        echo "Startup test completed (expected to timeout)"